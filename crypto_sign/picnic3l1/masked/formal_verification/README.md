This directory contains formal verification scripts that support provable security claims described in the [paper](https://eprint.iacr.org/2021/735.pdf). The script generated by `gen_gadgets.py` can be verified with [maskVerif](https://gitlab.com/benjgregoire/maskverif/-/tree/SPINI). Python3 and maskVerif are required. Installation of maskVerif can be done either via Nix or opam. See the build instructions of maskVerif below for details. We tested both approaches in Ubuntu 17.04 and 20.04.

## How to use `gen_gadgets.py`
```
python3 gen_gadgets.py -N <MPC parties> -n <LowMC block size in bits (must be a multiple of 3)> -r <LowMC rounds> -d <masking order> -t <"PICNIC" or "KKW">
```

### `PICNIC` mode
In this mode the script verifying two main gadgets (`PICNIC_OFFLINE` and `PICNIC_ONLINE`) as well as its composition (`PICNIC_MPC`) will be generated. The gadget `PICNIC_OFFLINE` corresponds to Alg.5; `PICNIC_ONLINE` corresponds to Alg.8; `PICNIC_MPC` corresponds to a single execution of MPC in Alg.4 of Appendix B. With a generated script one can confirm NI security of these.

### `KKW` mode 
In this mode the script verifying two gadgets (`KKW_AND_OFFLINE` and `KKW_AND_ONLINE`) will be generated.
These are main building blocks of our generic approach to mask the [Katz--Kolesnikov--Wang](https://eprint.iacr.org/2018/475.pdf) zero-knolwedge proof system. As proved in Lemma 1-2 of the paper both are SNI secure. 

### Example
```
python3 gen_gadgets.py -N 4 -n 9 -r 2 -d 1 -t PICNIC # generate first-order masked PICNIC instance with small block size
maskverif < PICNIC_N4_n9_r2_d1.mv # run maskverif on generated script
python3 gen_gadgets.py -N 4 -d 2 -t KKW # generate second-order masked KKW AND OFFLINE/ONLINE instances (parameters n and r are ignored)
maskverif < KKW_N4_d2.mv # run maskverif on generated script 
```

While maskVerif is verifying a gadget it outputs `Checking (S)NI for <gadget_name>: (no transition,no glitch)`. Once the verification is successful it should output `<gadget_name> is (S)NI at order <masking_order>`.

We note that performance of maskVerif degrades with the parameters due to the high complexity of verification. For the `PICNIC` mode we recommend `N=4`, `n = 6 or 9`, `r = 2 or 3`, `d = 1 or 2` to complete verification in a reasonable amount of time.

## Building maskVerif

Installation of maskVerif into `~/maskverif/` via opam on Ubuntu can be done via the following commands.

```
sudo apt-get install opam
opam init
opam install depext
opam depext conf-m4 conf-gmp
opam install ocamlfind ocamlbuild menhir zarith ocamlgraph batteries ppx_deriving ppx_import re
eval $(opam env)
git clone https://gitlab.com/benjgregoire/maskverif.git -b SPINI ~/maskverif
cd ~/maskverif/
make clean install
```
